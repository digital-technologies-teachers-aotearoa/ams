{% extends "base.html" %}

{% load i18n %}
{% load crispy_forms_tags %}

{% block title %}
  {% trans "Add Seats" %} - {{ organisation.name }}
{% endblock title %}

{% block content %}
  <div class="container my-5">
    <div class="row">
      <div class="col-12 col-md-8 offset-md-2">
        <h1>{% trans "Add Seats to" %} {{ organisation.name }}</h1>
        <!-- Current Membership Info -->
        <div class="alert alert-info mb-4">
          <h5 class="alert-heading">{% trans "Current Membership" %}</h5>
          <div class="row">
            <div class="col-12 col-md-6">
              <p class="mb-1">
                <strong>{% trans "Type:" %}</strong> {{ active_membership.membership_option.name }}
              </p>
              <p class="mb-1">
                <strong>{% trans "Expiry:" %}</strong> {{ active_membership.expiry_date|date:"d/m/Y" }}
              </p>
            </div>
            <div class="col-12 col-md-6">
              <p class="mb-1">
                <strong>{% trans "Current Seats:" %}</strong> {{ current_seats }}
              </p>
              {% if max_charged_seats %}
                <p class="mb-1">
                  <strong>{% trans "Charged Seats:" %}</strong> {{ current_chargeable_seats }} / {{ max_charged_seats }}
                </p>
                <p class="mb-1">
                  <strong>{% trans "Free Seats:" %}</strong> {{ active_membership.free_seats }}
                </p>
              {% endif %}
              <p class="mb-1">
                <strong>{% trans "Occupied:" %}</strong> {{ occupied_seats }}
              </p>
              {% if seats_available is not None %}
                <p class="mb-1">
                  <strong>{% trans "Available:" %}</strong> {{ seats_available }}
                </p>
              {% endif %}
            </div>
          </div>
        </div>
        <!-- Pro-Rata Info -->
        <div class="alert alert-warning mb-4">
          <h5 class="alert-heading">{% trans "Pro-Rata Pricing" %}</h5>
          <p class="mb-2">{% trans "Additional seats will be charged pro-rata based on the remaining membership period." %}</p>
          <p id="prorata-preview" class="mb-0 fs-5 fw-bold">{% trans "Enter number of seats to see the cost." %}</p>
        </div>
        <!-- Form -->
        {% crispy form %}
        <!-- Seats Breakdown -->
        <div id="seats-breakdown" class="alert alert-warning d-none">
          <h5 class="alert-heading">{% trans "Seats Breakdown" %}</h5>
          <p class="mb-1">
            <strong>{% trans "Seats being added:" %}</strong> <span id="breakdown-total">0</span>
          </p>
          <p class="mb-1">
            <strong>{% trans "Charged seats:" %}</strong> <span id="breakdown-chargeable">0</span>
          </p>
          <p class="mb-1">
            <strong>{% trans "Free seats:" %}</strong> <span id="breakdown-free">0</span>
          </p>
        </div>
      </div>
    </div>
  </div>
  <!-- JavaScript for live pro-rata calculation -->
  <script>
    (function() {
      // Get pre-calculated pro-rata cost for 1 seat from server
      const prorataCostPerSeat = parseFloat('{{ prorata_cost_per_seat }}');
      const maxChargedSeats = {
        {
          max_charged_seats |
            default: 'null'
        }
      };
      const currentChargeableSeats = {
        {
          current_chargeable_seats |
            default: '0'
        }
      };

      // Get form elements
      const seatsInput = document.getElementById('id_seats_to_add');
      const previewElement = document.getElementById('prorata-preview');
      const breakdownBox = document.getElementById('seats-breakdown');
      const breakdownTotal = document.getElementById('breakdown-total');
      const breakdownChargeable = document.getElementById('breakdown-chargeable');
      const breakdownFree = document.getElementById('breakdown-free');

      if (!seatsInput || !previewElement) {
        return;
      }

      // Function to calculate chargeable seats
      function calculateChargeableSeats(seatsToAdd) {
        if (!maxChargedSeats) {
          return seatsToAdd;
        }

        // Calculate how many more seats we can charge for
        const remainingChargeable = Math.max(0, maxChargedSeats - currentChargeableSeats);
        return Math.min(seatsToAdd, remainingChargeable);
      }

      // Function to calculate and display pro-rata cost
      function updateProrataPreview() {
        const seats = parseInt(seatsInput.value) || 0;

        if (seats <= 0) {
          previewElement.textContent = '{% trans "Enter number of seats to see the cost." %}';
          if (breakdownBox) {
            breakdownBox.style.display = 'none';
          }
          return;
        }

        // Calculate chargeable and free seats
        const chargeableSeats = calculateChargeableSeats(seats);
        const freeSeats = seats - chargeableSeats;

        // Multiply pre-calculated cost per seat by number of chargeable seats
        const prorataCost = (prorataCostPerSeat * chargeableSeats).toFixed(2);

        // Format as currency
        const formattedCost = '$' + prorataCost;

        // Update preview
        if (chargeableSeats === seats) {
          previewElement.textContent = '{% trans "Estimated cost:" %} ' + formattedCost +
            ' {% trans "for" %} ' + seats + ' {% trans "seat(s)" %}';
        } else {
          previewElement.textContent = '{% trans "Estimated cost:" %} ' + formattedCost +
            ' {% trans "for" %} ' + chargeableSeats + ' {% trans "charged seat(s)" %} ' +
            '(' + freeSeats + ' {% trans "free" %})';
        }

        // Show breakdown if there are free seats
        if (breakdownBox && maxChargedSeats) {
          breakdownTotal.textContent = seats;
          breakdownChargeable.textContent = chargeableSeats;
          breakdownFree.textContent = freeSeats;
          breakdownBox.style.display = 'block';
        }
      }

      // Add event listener
      seatsInput.addEventListener('input', updateProrataPreview);

      // Initial calculation if value exists
      updateProrataPreview();
    })();
  </script>
{% endblock content %}
